---
layout:     post
title:      Protobuf
subtitle:   进阶
date:       2023-08-31
author:     lx
header-img: img/Embedded-System/ES.png
catalog: true
categories: Protobuf
tags:
    - 嵌入式
    - protobuf
---

> 参考链接：https://blog.csdn.net/carson_ho/article/details/70568606

## Protobuf编码方式

- Varint编码 
    Varint编码是一种变长的编码方式，编码原理是用字节表示数字，值越小的数字，使用越少的字节数表示。因此，可以通过减少表示数字的字节数进行数据压缩。
    对int32类型的数字，一般需要4个字节表示。如果采用Varint编码，对于很小的int32类型数字，则可以用1个字节来表示；虽然大的数字会需要5个字节来表示，但大多数情况下，消息都不会有很大的数字，所以采用Varint编码方式总是可以用更少的字节数来表示数字。
    Varint编码后每个字节的最高位都有特殊含义：
    A、如果是1，表示后续的字节也是数字的一部分。
    B、如果是0，表示本字节是最后一个字节，且剩余7位都用来表示数字

    对于一个int32类型的值300的Varint编码如下：
    300的二进制编码为：100101100(256+32+8+4)
    从字节流末尾取出7bit并在最高位增加1构成一个字节：[1]010 1100
    从字节流末尾取出7bit并在最高位增加1构成一个字节，如果是最后一个字节增加0：[0]0000010
    两字节为：[0]0000010 [1]010 1100
    转换为小端模式：10101100 00000010
    编码结果：1010 1100 0000 0010

- Zigzag编码
    Zigazg编码是一种变长的编码方式，其编码原理是使用无符号数来表示有符号数字，使得绝对值小的数字都可以采用较少字节来表示，特别对表示负数的数据能更好地进行数据压缩。
    Zigzag编码对Varint编码在表示负数时不足的补充，从而更好的帮助Protobuf进行数据的压缩。因此，如果提前预知字段值是可能取负数的时候，需要采用sint32/sint64数据类型。
    Protobuf通过Varint和Zigzag编码后，大大减少了字段值占用字节数。

## Protobuf存储方式

#### T-L-V数据存储方式

T-L-V(Tag - Length - Value)，即标识符-长度-字段值的存储方式，其原理是以标识符-长度-字段值表示单个数据，最终将所有数据拼接成一个字节流，从而实现数据存储的功能。
其中Length可选存储，如储存Varint编码数据就不需要存储Length，此时为T-V存储方式。

T-L-V 存储方式的优点：
    A、不需要分隔符就能分隔开字段，减少了分隔符的使用。
    B、各字段存储得非常紧凑，存储空间利用率非常高。
    C、如果某个字段没有被设置字段值，那么该字段在序列化时的数据中是完全不存在的，即不需要编码，相应字段在解码时才会被设置为默认值。

![TLV](/img/Embedded-System/protobuf_tlv.png)


#### L-V数据存储方式

消息字段的标识号、数据类型、字段值经过Protobuf采用Varint和Zigzag编码后，以T-V(Tag-Value)方式进行数据存储。
对于Varint与Zigzag编码方式编码的数据，省略了T-L-V中的字节长度Length

![LV](/img/Embedded-System/protobuf_lv.png)


## Protobuf序列化原理解析

Protobuf对于数据存储的三大原则：
(1)Protocol Buffer将消息中的每个字段进行编码后，利用T - L - V 存储方式进行数据的存储，最终得到一个二进制字节流。
(2)ProtoBuf对于不同数据类型采用不同的序列化方式(数据编码方式与数据存储方式)
Protobuf对于不同的字段类型采用不同的编码和数据存储方式对消息字段进行序列化，以确保得到高效紧凑的数据压缩


## Protobuf序列化注意事项

- packed修饰的 repeat 字段

- 多用 optional或 repeated修饰符
若optional 或 repeated 字段没有被设置字段值，那么该字段在序列化时的数据中是完全不存在的，即不需要进行编码，但相应的字段在解码时会被设置为默认值

- 字段标识号(Field_Number)尽量只使用1-15，且不要跳动使用
Tag是需要占字节空间的。如果Field_Number>16时，Field_Number的编码就会占用2个字节，那么Tag在编码时就会占用更多的字节；如果将字段标识号定义为连续递增的数值，将获得更好的编码和解码性能

- 若需要使用的字段值出现负数，请使用sint32/sint64，不要使用int32/int64。
采用sint32/sint64数据类型表示负数时，会先采用Zigzag编码再采用Varint编码，从而更加有效压缩数据；int32类型：存正数时最多需要5个字节，存负数时必定需要10个字节

- string类型：proto3中字符串默认为值为空字符串，序列化后不占用内存空间；单个英文字符占1个字节，单个中文字符占3个字节

- bool类型：proto3中布尔值默认为值为fasle，因此当值为false时，序列化后不占用内存空间；当布尔值为true时，占用1个字节

- 对于经纬度等浮点数，将其转为整型数据，用int64编码更省空间

- 若大数值占比大，则使用fixed32或fixed64



